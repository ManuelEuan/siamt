version: "3.9"
services:
  gateway:
    image: registry.gitlab.com/yucatan/siamt/gateway-pd
    ports:
      - target: 80
        published: 80
        protocol: tcp
        mode: host
      - target: 443
        published: 443
        protocol: tcp
        mode: host
    volumes:
      - "frontend:/srv/www"
      - "/var/www:/var/www"
    env_file:
      - ../../../.pd-env
    networks:
      - internal-services
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - "app-api"
      - "auth-api"
      - "app-ui"
  wss-njs:
    image: registry.gitlab.com/yucatan/siamt/wss-njs-pd
    ports:
      - target: 3000
        published: 8443
        protocol: tcp
        mode: host
    env_file:
      - ../../../.pd-env
    networks:
      - internal-services
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - "liquibase"
      - "redis"
  app-ui:
    image: registry.gitlab.com/yucatan/siamt/app-ui-pd
    volumes:
      - "frontend:/srv/www"
    env_file:
      - ../../../.pd-env
    networks:
      - internal-services
  auth-api:
    image: registry.gitlab.com/yucatan/siamt/auth-api-pd
    env_file:
      - ../../../.pd-env
    networks:
      - internal-services
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - "liquibase"
      - "redis"
  app-api:
    image: registry.gitlab.com/yucatan/siamt/app-api-pd
    env_file:
      - ../../../.pd-env
    networks:
      - internal-services
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - "liquibase"
      - "redis"
  redis:
    image: redis
    volumes:
      - "queue:/data"
    networks:
      - internal-services
    sysctls:
      net.core.somaxconn: 1024
  liquibase:
    image: registry.gitlab.com/yucatan/siamt/liquibase-pd
    env_file:
      - ../../../.pd-env
    networks:
      - internal-services
    extra_hosts:
      - "host.docker.internal:host-gateway"
volumes:
  frontend:
  queue:
networks:
  internal-services:
    ipam:
      driver: default
      config:
        - subnet: "172.31.248.0/21"